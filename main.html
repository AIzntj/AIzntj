<!-- main.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿å…­æ™ºèƒ½ç»Ÿè®¡ç³»ç»Ÿ</title>
    <!-- åŸæœ‰CSSæ ·å¼ä¿æŒä¸å˜ -->
    <style>
        /* åŸæœ‰çš„æ‰€æœ‰CSSæ ·å¼éƒ½ä¿ç•™åœ¨è¿™é‡Œ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            padding: 15px;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
        }
        
        /* ... æ‰€æœ‰åŸæœ‰æ ·å¼ ... */
        
        /* æ–°å¢ï¼šç”¨æˆ·ä¿¡æ¯æ  */
        .user-info-bar {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .user-info-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .user-details h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .user-details p {
            margin: 2px 0 0 0;
            font-size: 12px;
            opacity: 0.9;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* æ–°å¢ï¼šä½¿ç”¨æ—¶é—´ç»Ÿè®¡ */
        .usage-stats {
            background: white;
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
    <div class="user-info-bar">
        <div class="user-info-left">
            <div class="user-avatar">ğŸ‘¤</div>
            <div class="user-details">
                <h3 id="userDisplayName">åŠ è½½ä¸­...</h3>
                <p id="userStatus">è´¦æˆ·çŠ¶æ€ï¼šéªŒè¯ä¸­...</p>
            </div>
        </div>
        <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>
    
    <!-- ä½¿ç”¨æ—¶é—´ç»Ÿè®¡ -->
    <div class="usage-stats">
        æœ¬æ¬¡ç™»å½•æ—¶é—´ï¼š<span id="currentLoginTime">--:--:--</span> | 
        ä»Šæ—¥ä½¿ç”¨ï¼š<span id="todayUsage">0åˆ†é’Ÿ</span> | 
        æ€»ä½¿ç”¨ï¼š<span id="totalUsage">0åˆ†é’Ÿ</span>
    </div>
    
    <!-- åŸæœ‰ç³»ç»Ÿå®¹å™¨ -->
    <div id="appPage">
        <h1>é˜¿å…­æ™ºèƒ½ç»Ÿè®¡</h1>
        
        <div class="container">
            <!-- æµ®åŠ¨åå­—é€‰æ‹©æ¡† -->
            <div class="sticky-name-selector">
                <div class="input-group" style="margin-bottom: 0;">
                    <label for="nameList">é€‰æ‹©åå­—:</label>
                    <select id="nameList">
                        <option value="è¯·é€‰æ‹©">default</option>
                    </select>
                </div>
            </div>
            
            <div class="input-group">
                <label for="inputText">è¾“å…¥å†…å®¹ (æ¯è¡Œä¸€ä¸ªè®°å½•):</label>
                <textarea id="inputText" placeholder="ä¾‹å¦‚: è›‡å„100&#10;æˆ–: 1.2.3+50&#10;å¤šæ¡è®°å½•ç”¨ï¼ï¼Œéš”å¼€"></textarea>
            </div>
            
            <!-- å‰å››ä¸ªæŒ‰é’®ä¸¤åˆ—æ˜¾ç¤º -->
            <div class="button-group">
                <button id="submitBtn" class="success">æäº¤</button>
                <button id="clearDataBtn" class="danger">æ¸…é™¤æ•°æ®</button>
                <button id="manageUsersBtn">ç®¡ç†ç”¨æˆ·</button>
                <button id="showRecordsBtn">å¯¹å•/ä¿®æ”¹</button>
            </div>
            
            <!-- ç»“ç®—é¡µé¢æŒ‰é’®å•ç‹¬ä¸€è¡Œ -->
            <button id="switchToSettlementBtn" class="single-button">ç»“ç®—é¡µé¢</button>
            
            <div class="mode-buttons">
                <button id="totalModeBtn" class="active">æ€»é‡</button>
                <button id="personalModeBtn">ä¸ªäºº</button>
            </div>
        </div>
        
        <!-- å·ç æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="display-area" id="numbersDisplayArea">
            <div class="stats-info" id="statsInfo">
                <h3 id="displayTitle">æ€»é‡æ˜¾ç¤º - æ‰€æœ‰ç”¨æˆ·åˆè®¡</h3>
                <p id="statsText">æ€»è®°å½•æ•°: 0 æ¡ | æ€»æ•°é‡: 0</p>
            </div>
            
            <div class="numbers-grid">
                <div class="number-column" id="numberColumn1">
                    <!-- å·ç å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
                <div class="number-column" id="numberColumn2">
                    <!-- å·ç å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </div>
        
        <!-- ç»“ç®—å’Œè¯„ä¼°ç³»ç»ŸåŒºåŸŸ (åˆå§‹éšè—) -->
        <div class="display-area" id="settlementEvaluationArea" style="display: none;">
            <!-- ç»“ç®—ç³»ç»Ÿ -->
            <div class="settlement-section">
                <h2>ç»“ç®—ç³»ç»Ÿ</h2>
                <div class="input-group">
                    <label for="winningNumber">å¼€å¥–å·ç :</label>
                    <input type="text" id="winningNumber" placeholder="è¾“å…¥å¼€å¥–å·ç ">
                </div>
                
                <div class="button-group">
                    <button id="calculateSettlementBtn" class="success">å¼€å§‹ç»“ç®—</button>
                </div>
                
                <div id="settlementResult">
                    <!-- ç»“ç®—ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            
            <!-- è¯„ä¼°ç³»ç»Ÿ -->
            <div class="evaluation-section">
                <h2>è¯„ä¼°ç³»ç»Ÿ</h2>
                <div class="button-group">
                    <button id="evaluateBtn" class="success">è¯„ä¼°</button>
                </div>
                
                <div id="evaluationResult">
                    <!-- è¯„ä¼°ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <div class="input-group">
                    <label for="thresholdInput">åƒç é‡‘é¢:</label>
                    <input type="number" id="thresholdInput" placeholder="è¾“å…¥é‡‘é¢">
                </div>
                
                <div class="button-group">
                    <button id="calculateExcessBtn">åƒç è®¡ç®—</button>
                </div>
                
                <div id="excessResult">
                    <!-- åƒç ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
        
        <!-- åŸæœ‰æ‰€æœ‰æ¨¡æ€æ¡†ä¿æŒä¸å˜ -->
        <!-- ... åŸæœ‰æ‰€æœ‰modalä»£ç  ... -->
    </div>

    <!-- å¼•å…¥Supabaseå®¢æˆ·ç«¯ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let currentMode = 'total';
        let totalRecords = [];
        let users = [];
        let lastClearTime = null;
        let currentEditingRecordIndex = null;
        
        // Supabaseé…ç½®
        const SUPABASE_URL = 'https://mzsuaimcgphlcfrenrwg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16c3VhaW1jZ3BobGNmcmVucndnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTA4OTYsImV4cCI6MjA4MDMyNjg5Nn0.Hf1Q6JQ-KHfmh58BIjDgzBTS5DVIQxXbnIKXfjKPQg4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // å½“å‰ç”¨æˆ·ä¿¡æ¯
        let currentUser = null;
        
        // åˆå§‹åŒ–å‡½æ•°
        async function initializeApp() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                window.location.href = 'login.html';
                return;
            }
            
            // åŠ è½½ç”¨æˆ·æ•°æ®
            await loadCurrentUser();
            
            // åˆå§‹åŒ–åŸæœ‰ç³»ç»Ÿ
            loadUsers();
            loadAllRecords();
            loadLastClearTime();
            refreshDisplay();
            initializeControls();
            
            // å¼€å§‹ä½¿ç”¨æ—¶é—´ç»Ÿè®¡
            startUsageTimer();
        }
        
        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuth() {
            const authToken = localStorage.getItem('auth_token');
            const userPasswordHash = localStorage.getItem('user_password_hash');
            
            if (!authToken || !userPasswordHash) {
                return false;
            }
            
            try {
                const [storedHash, deviceFingerprint] = atob(authToken).split(':');
                
                if (storedHash !== userPasswordHash) {
                    return false;
                }
                
                // éªŒè¯ç”¨æˆ·çŠ¶æ€
                const { data: user } = await supabase
                    .from('users')
                    .select('*')
                    .eq('password_hash', userPasswordHash)
                    .single();
                
                if (!user || user.status !== 'active') {
                    return false;
                }
                
                // éªŒè¯è®¾å¤‡
                const { data: devices } = await supabase
                    .from('devices')
                    .select('*')
                    .eq('password_hash', userPasswordHash)
                    .eq('device_fingerprint', deviceFingerprint);
                
                if (!devices || devices.length === 0) {
                    return false;
                }
                
                return true;
                
            } catch (error) {
                console.error('è®¤è¯æ£€æŸ¥å¤±è´¥ï¼š', error);
                return false;
            }
        }
        
        // åŠ è½½å½“å‰ç”¨æˆ·ä¿¡æ¯
        async function loadCurrentUser() {
            const userPasswordHash = localStorage.getItem('user_password_hash');
            
            if (!userPasswordHash) {
                logout();
                return;
            }
            
            const { data: user } = await supabase
                .from('users')
                .select('*')
                .eq('password_hash', userPasswordHash)
                .single();
            
            if (user) {
                currentUser = user;
                
                // æ›´æ–°ç”¨æˆ·ç•Œé¢æ˜¾ç¤º
                document.getElementById('userDisplayName').textContent = user.display_name || 'ç”¨æˆ·';
                
                // æ›´æ–°è´¦æˆ·çŠ¶æ€
                let statusText = 'è´¦æˆ·çŠ¶æ€ï¼š';
                if (user.status === 'active') {
                    if (user.expire_date) {
                        const expireDate = new Date(user.expire_date);
                        const now = new Date();
                        const daysLeft = Math.ceil((expireDate - now) / (1000 * 60 * 60 * 24));
                        statusText += `æ­£å¸¸ï¼ˆå‰©ä½™${daysLeft}å¤©ï¼‰`;
                    } else {
                        statusText += 'æ­£å¸¸ï¼ˆæ°¸ä¹…ï¼‰';
                    }
                } else {
                    statusText += user.status === 'inactive' ? 'å·²åœç”¨' : 'å·²è¿‡æœŸ';
                }
                
                document.getElementById('userStatus').textContent = statusText;
                
                // å¦‚æœç”¨æˆ·æœ‰å¤‡æ³¨ï¼Œæ·»åŠ åˆ°æ ‡é¢˜
                if (user.note) {
                    document.querySelector('h1').textContent += ` - ${user.note}`;
                }
            }
        }
        
        // ä½¿ç”¨æ—¶é—´ç»Ÿè®¡
        let usageTimer = null;
        let sessionStartTime = null;
        
        function startUsageTimer() {
            sessionStartTime = parseInt(localStorage.getItem('login_time') || Date.now());
            
            // æ›´æ–°å½“å‰ä¼šè¯æ—¶é—´
            function updateTimer() {
                const now = Date.now();
                const sessionSeconds = Math.floor((now - sessionStartTime) / 1000);
                
                // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
                const hours = Math.floor(sessionSeconds / 3600);
                const minutes = Math.floor((sessionSeconds % 3600) / 60);
                const seconds = sessionSeconds % 60;
                
                document.getElementById('currentLoginTime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ€»ä½¿ç”¨æ—¶é—´
                if (sessionSeconds % 60 === 0 && currentUser) {
                    updateTotalUsageTime();
                }
            }
            
            // åˆå§‹æ›´æ–°
            updateTimer();
            
            // æ¯ç§’æ›´æ–°ä¸€æ¬¡
            usageTimer = setInterval(updateTimer, 1000);
        }
        
        // æ›´æ–°æ€»ä½¿ç”¨æ—¶é—´
        async function updateTotalUsageTime() {
            if (!currentUser) return;
            
            const sessionSeconds = Math.floor((Date.now() - sessionStartTime) / 1000);
            const newTotalTime = (currentUser.total_login_time || 0) + 60; // æ¯åˆ†é’Ÿå¢åŠ 60ç§’
            
            // æ›´æ–°æ•°æ®åº“
            await supabase
                .from('users')
                .update({ total_login_time: newTotalTime })
                .eq('password_hash', currentUser.password_hash);
            
            // æ›´æ–°æ˜¾ç¤º
            const totalMinutes = Math.floor(newTotalTime / 60);
            const totalHours = Math.floor(totalMinutes / 60);
            const remainingMinutes = totalMinutes % 60;
            
            document.getElementById('totalUsage').textContent = 
                totalHours > 0 ? `${totalHours}å°æ—¶${remainingMinutes}åˆ†é’Ÿ` : `${totalMinutes}åˆ†é’Ÿ`;
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_password_hash');
            localStorage.removeItem('user_display_name');
            localStorage.removeItem('login_time');
            
            // åœæ­¢è®¡æ—¶å™¨
            if (usageTimer) {
                clearInterval(usageTimer);
            }
            
            // è®°å½•é€€å‡ºæ—¥å¿—
            if (currentUser) {
                supabase
                    .from('usage_logs')
                    .insert({
                        password_hash: currentUser.password_hash,
                        action: 'logout',
                        user_agent: navigator.userAgent
                    });
            }
            
            // è·³è½¬åˆ°ç™»å½•é¡µ
            window.location.href = 'login.html';
        }
        
        // åŸæœ‰çš„æ‰€æœ‰å‡½æ•°éƒ½ä¿ç•™åœ¨è¿™é‡Œ
        // æ³¨æ„ï¼šéœ€è¦ä¿®æ”¹æ‰€æœ‰ä½¿ç”¨localStorageçš„å‡½æ•°ï¼Œæ”¹ä¸ºä½¿ç”¨Supabase
        
        // ä¿®æ”¹loadUserså‡½æ•°ï¼Œä»SupabaseåŠ è½½
        async function loadUsers() {
            // ä»SupabaseåŠ è½½ç”¨æˆ·æ•°æ®
            const { data, error } = await supabase
                .from('user_settings')
                .select('*')
                .eq('password_hash', localStorage.getItem('user_password_hash'));
            
            if (error) {
                console.error('åŠ è½½ç”¨æˆ·è®¾ç½®å¤±è´¥ï¼š', error);
                users = [{ name: 'default', rate: 45, rebate: 3 }];
            } else if (data && data.length > 0) {
                users = data[0].settings || [{ name: 'default', rate: 45, rebate: 3 }];
            } else {
                users = [{ name: 'default', rate: 45, rebate: 3 }];
            }
            
            updateNameSelect();
        }
        
        // ä¿®æ”¹saveUsersToStorageå‡½æ•°
        async function saveUsersToStorage() {
            if (!currentUser) return;
            
            await supabase
                .from('user_settings')
                .upsert({
                    password_hash: currentUser.password_hash,
                    settings: users,
                    updated_at: new Date().toISOString()
                });
        }
        
        // ä¿®æ”¹loadAllRecordså‡½æ•°
        async function loadAllRecords() {
            if (!currentUser) return;
            
            const { data, error } = await supabase
                .from('user_records')
                .select('*')
                .eq('password_hash', currentUser.password_hash);
            
            if (error) {
                console.error('åŠ è½½è®°å½•å¤±è´¥ï¼š', error);
                totalRecords = [];
            } else if (data && data.length > 0) {
                totalRecords = data[0].records || [];
            } else {
                totalRecords = [];
            }
        }
        
        // ä¿®æ”¹saveAllRecordså‡½æ•°
        async function saveAllRecords() {
            if (!currentUser) return;
            
            await supabase
                .from('user_records')
                .upsert({
                    password_hash: currentUser.password_hash,
                    records: totalRecords,
                    updated_at: new Date().toISOString()
                });
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            const totalDict = calculateTotal();
            let totalQuantity = 0;
            
            Object.values(totalDict).forEach(count => {
                totalQuantity += count;
            });
            
            await supabase
                .from('user_stats')
                .upsert({
                    password_hash: currentUser.password_hash,
                    total_records: totalRecords.length,
                    total_quantity: totalQuantity,
                    last_updated: new Date().toISOString()
                });
        }
        
        // åŸæœ‰å…¶ä»–å‡½æ•°éƒ½ä¿æŒä¸å˜...
        // ... åŸæœ‰æ‰€æœ‰ç»Ÿè®¡ç³»ç»Ÿçš„JavaScriptä»£ç  ...
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // åŸæœ‰çš„initializeControlså‡½æ•°
        function initializeControls() {
            // åŸæœ‰çš„äº‹ä»¶ç›‘å¬å™¨ä»£ç ...
        }
    </script>
    
    <!-- åŸæœ‰æ‰€æœ‰å…¶ä»–JavaScriptä»£ç éƒ½æ”¾åœ¨è¿™é‡Œ -->
</body>
</html>