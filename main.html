<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>é˜¿å…­æ™ºèƒ½ç»Ÿè®¡ç³»ç»Ÿ</title><style>*{box-sizing:border-box;margin:0;padding:0;font-family:"PingFang SC","Microsoft YaHei",sans-serif}body{background-color:#f5f5f5;padding:15px;color:#333;max-width:900px;margin:0 auto}.container{background-color:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:15px;margin-bottom:15px}h1{text-align:center;margin-bottom:15px;color:#2c3e50;font-size:1.5rem}h2{margin-bottom:10px;color:#2c3e50;font-size:1.2rem}.input-group{margin-bottom:15px}label{display:block;margin-bottom:5px;font-weight:bold}select,textarea,input{width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;font-size:16px}textarea{min-height:120px;resize:vertical}.button-group{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px}.single-button{width:100%;margin-bottom:15px}button{padding:10px;border:0;border-radius:5px;background-color:#3498db;color:#fff;font-size:16px;cursor:pointer;transition:background-color .3s}button:hover{background-color:#2980b9}button.danger{background-color:#e74c3c}button.danger:hover{background-color:#c0392b}button.success{background-color:#2ecc71}button.success:hover{background-color:#27ae60}.mode-buttons{display:flex;gap:10px;margin-bottom:15px}.mode-buttons button{flex:1}.mode-buttons button.active{background-color:#2c3e50}.display-area{background-color:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:15px;margin-bottom:15px}.stats-info{margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #eee}.numbers-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}.number-column{display:flex;flex-direction:column;gap:8px}.number-item{display:flex;justify-content:space-between;padding:8px;background-color:#f8f9fa;border-radius:5px;font-size:14px}.number-code{font-weight:bold}.number-count{color:#e74c3c;font-weight:bold}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:1000}.modal-content{background-color:#fff;padding:20px;border-radius:10px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto}.modal h2{margin-bottom:15px}.modal input{width:100%;padding:10px;margin-bottom:15px;border:1px solid #ddd;border-radius:5px;font-size:16px}.modal-buttons{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}.login-container{background-color:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:20px;max-width:400px;margin:50px auto}.login-container h1{margin-bottom:20px}.record-item{padding:10px;border-bottom:1px solid #eee}.settlement-section,.evaluation-section{background-color:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:15px;margin-bottom:15px}.rate-buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:15px}.rate-buttons button{padding:8px}.rate-buttons button.active{background-color:#2c3e50}.result-display{padding:10px;border-radius:5px;margin-bottom:10px}.profit{background-color:#e8f5e9;color:#2e7d32}.loss{background-color:#ffebee;color:#c62828}.evaluation-result{margin-top:10px;padding:10px;background-color:#f8f9fa;border-radius:5px}.sticky-name-selector{position:sticky;top:0;background-color:#fff;z-index:100;padding:10px 15px;margin:0 -15px 15px -15px;border-bottom:1px solid #eee;box-shadow:0 2px 5px rgba(0,0,0,.1)}.user-table{width:100%;border-collapse:collapse;margin-bottom:15px}.user-table th,.user-table td{padding:10px;border:1px solid #ddd;text-align:center}.user-table th{background-color:#f2f2f2;font-weight:bold}.user-table input{width:100%;padding:5px;border:1px solid #ccc;border-radius:3px}.user-table button{padding:5px 10px;font-size:14px}.settlement-table{width:100%;border-collapse:collapse;margin:15px 0}.settlement-table th,.settlement-table td{padding:10px;border:1px solid #ddd;text-align:center;font-size:14px}.settlement-table th{background-color:#f2f2f2;font-weight:bold}.settlement-table tfoot td{background-color:#f8f9fa;font-weight:bold}.settlement-table button{padding:5px 10px;font-size:14px}.edit-record-modal textarea{min-height:100px}.excess-group{margin-bottom:8px;padding:8px;background-color:#f8f9fa;border-radius:5px;display:flex;justify-content:space-between;align-items:center}.excess-numbers{font-weight:bold;color:#2c3e50}.excess-amount{color:#e74c3c;font-weight:bold;margin-left:10px}.excess-animals{font-size:12px;color:#7f8c8d;margin-top:2px}.copy-success{background-color:#27ae60!important}.copy-btn-pulse{animation:pulse .5s ease-in-out}@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}.user-info-bar{background:linear-gradient(135deg,#2c3e50 0%,#3498db 100%);color:#fff;padding:10px 15px;border-radius:10px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}.user-info-left{display:flex;align-items:center;gap:10px}.user-avatar{width:40px;height:40px;background:rgba(255,255,255,.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px}.user-details h3{margin:0;font-size:16px}.user-details p{margin:2px 0 0;font-size:12px;opacity:.9}.logout-btn{background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);padding:8px 15px;border-radius:5px;cursor:pointer;transition:all .3s}.logout-btn:hover{background:rgba(255,255,255,.3)}@media (max-width:768px){.button-group{grid-template-columns:repeat(2,1fr)}.numbers-grid{grid-template-columns:repeat(2,1fr)}.rate-buttons{grid-template-columns:repeat(4,1fr)}.number-item{padding:6px;font-size:13px}h1{font-size:1.3rem}h2{font-size:1.1rem}.user-table,.settlement-table{font-size:12px}.user-table th,.user-table td,.settlement-table th,.settlement-table td{padding:6px}.user-info-bar{padding:8px 10px;flex-direction:column;gap:10px;align-items:stretch}.user-info-left{justify-content:space-between}.logout-btn{width:100%}.usage-stats{padding:8px 10px;font-size:12px;}}@media (max-width:480px){.numbers-grid{gap:6px}.number-item{padding:4px;font-size:12px}.rate-buttons{grid-template-columns:repeat(4,1fr);gap:8px;.rate-buttons button{padding:6px 4px;font-size:13px}.button-group{grid-template-columns: repeat(2, 1fr);gap: 8px;.button-group button{padding:8px 5px;font-size:14px;}.user-table,.settlement-table{font-size:11px}.user-table th,.user-table td,.settlement-table th,.settlement-table td{padding:4px}.user-info-left{flex-direction:column;text-align:center;gap:5px}.user-details h3{font-size:14px}.user-details p{font-size:11px}}</style></head><body><div class=user-info-bar><div class=user-info-left><div class=user-avatar>ğŸ‘¤</div><div class=user-details><h3 id=userDisplayName>åŠ è½½ä¸­...</h3><p id=userStatus>è´¦æˆ·çŠ¶æ€ï¼šéªŒè¯ä¸­...</p></div></div><button class=logout-btn onclick=logoutUser()>é€€å‡ºç™»å½•</button></div><div id=appPage><h1>é˜¿å…­æ™ºèƒ½ç»Ÿè®¡</h1><div class=container><div class=sticky-name-selector><div class=input-group style=margin-bottom:0><label for=nameList>é€‰æ‹©åå­—:</label><select id=nameList><option value=è¯·é€‰æ‹©>default</option></select></div></div><div class=input-group><label for=inputText>è¾“å…¥å†…å®¹ (æ¯è¡Œä¸€ä¸ªè®°å½•):</label><textarea id=inputText placeholder="ä¾‹å¦‚: è›‡å„100&#10;æˆ–: 1.2.3+50&#10;å¤šæ¡è®°å½•ç”¨ï¼ï¼Œéš”å¼€"></textarea></div><div class=button-group><button id=submitBtn class=success onclick=submitData()>æäº¤</button><button id=clearDataBtn class=danger onclick=showClearConfirm()>æ¸…é™¤æ•°æ®</button><button id=manageUsersBtn onclick=showUserManagement()>ç®¡ç†ç”¨æˆ·</button><button id=showRecordsBtn onclick=showRecords()>å¯¹å•/ä¿®æ”¹</button></div><button id=switchToSettlementBtn class=single-button onclick=toggleDisplay()>ç»“ç®—é¡µé¢</button><div class=mode-buttons><button id=totalModeBtn class=active onclick=setMode('total')>æ€»é‡</button><button id=personalModeBtn onclick=setMode('personal')>ä¸ªäºº</button></div></div><div class=display-area id=numbersDisplayArea><div class=stats-info id=statsInfo><h3 id=displayTitle>æ€»é‡æ˜¾ç¤º - æ‰€æœ‰ç”¨æˆ·åˆè®¡</h3><p id=statsText>æ€»è®°å½•æ•°: 0 æ¡ | æ€»æ•°é‡: 0</p></div><div class=numbers-grid><div class=number-column id=numberColumn1></div><div class=number-column id=numberColumn2></div></div></div><div class=display-area id=settlementEvaluationArea style=display:none><div class=settlement-section><h2>ç»“ç®—ç³»ç»Ÿ</h2><div class=input-group><label for=winningNumber>å¼€å¥–å·ç :</label><input type=text id=winningNumber placeholder=è¾“å…¥å¼€å¥–å·ç ></div><div class=button-group><button id=calculateSettlementBtn class=success onclick=calculateSettlement()>å¼€å§‹ç»“ç®—</button></div><div id=settlementResult></div></div><div class=evaluation-section><h2>è¯„ä¼°ç³»ç»Ÿ</h2><div class=button-group><button id=evaluateBtn class=success onclick=evaluateSystem()>è¯„ä¼°</button></div><div id=evaluationResult></div><div class=input-group><label for=thresholdInput>åƒç é‡‘é¢:</label><input type=number id=thresholdInput placeholder=è¾“å…¥é‡‘é¢></div><div class=button-group><button id=calculateExcessBtn onclick=calculateExcess()>åƒç è®¡ç®—</button></div><div id=excessResult></div></div></div><div class=modal id=userManagementModal><div class=modal-content><h2>ç”¨æˆ·ç®¡ç†</h2><table class=user-table><thead><tr><th>åˆ é™¤</th><th>ç”¨æˆ·åå­—</th><th>å€ç‡</th><th>è¿”æ°´%</th></tr></thead><tbody id=userTableBody></tbody></table><div class=input-group><label for=newUserName>æ–°å¢ç”¨æˆ·:</label><div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:10px"><input type=text id=newUserName placeholder=ç”¨æˆ·åå­—><input type=number id=newUserRate placeholder=å€ç‡ value=45><input type=number id=newUserRebate placeholder="è¿”æ°´%" value=3></div><small style=color:#666></small></div><div class=modal-buttons><button id=addUserBtn onclick=addNewUser()>æ–°å¢ç”¨æˆ·</button><button id=saveUsersBtn class=success onclick=saveUsers()>ä¿å­˜è®¾ç½®</button><button id=closeUserManagementBtn onclick=hideUserManagement()>å…³é—­</button></div></div></div><div class=modal id=settlementResultModal><div class=modal-content><h2>ç»“ç®—ç»“æœ</h2><div class=input-group><label>å¼€å¥–å·ç : <span id=settlementWinningNumbers></span></label></div><div style="max-height:400px;overflow-y:auto"><table class=settlement-table id=settlementTable><thead><tr><th>åå­—</th><th>ä¸‹æ³¨æ€»è®¡</th><th>è¿”æ°´é‡‘é¢</th><th>æ‰£è¿”æ°´</th><th>ä¸­å¥–é‡‘é¢</th><th>ç›ˆäº</th><th>å¤åˆ¶</th></tr></thead><tbody id=settlementTableBody></tbody><tfoot id=settlementTableFooter></tfoot></table></div><div class=modal-buttons><button id=closeSettlementResultBtn onclick=hideSettlementResult()>å…³é—­</button></div></div></div><div class="modal edit-record-modal" id=recordsModal><div class=modal-content><h2>å¯¹å•/ä¿®æ”¹</h2><div id=recordsList></div><div id=editRecordForm style=display:none><h3>ç¼–è¾‘è®°å½•</h3><div class=input-group><label for=editRecordContent>è®°å½•å†…å®¹:</label><textarea id=editRecordContent placeholder=ä¿®æ”¹è®°å½•å†…å®¹></textarea></div><div class=modal-buttons><button id=cancelEditBtn onclick=cancelEdit()>å–æ¶ˆ</button><button id=saveEditBtn class=success onclick=saveEdit()>ä¿å­˜ä¿®æ”¹</button></div></div><div class=modal-buttons><button id=closeRecordsBtn onclick=hideRecords()>å…³é—­</button></div></div></div><div class=modal id=confirmClearModal><div class=modal-content><h2>ç¡®è®¤æ¸…é™¤æ•°æ®</h2><p>ç¡®å®šè¦æ¸…é™¤å…¨éƒ¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p><div class=modal-buttons><button id=cancelClearBtn onclick=hideClearConfirm()>å–æ¶ˆ</button><button id=confirmClearBtn class=danger onclick=confirmClearData()>ç¡®è®¤æ¸…é™¤</button></div></div></div></div><script src=https://unpkg.com/@supabase/supabase-js@2></script><script>
// Supabaseé…ç½®
const supabaseUrl='https://mzsuaimcgphlcfrenrwg.supabase.co';
const supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16c3VhaW1jZ3BobGNmcmVucndnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTA4OTYsImV4cCI6MjA4MDMyNjg5Nn0.Hf1Q6JQ-KHfmh58BIjDgzBTS5DVIQxXbnIKXfjKPQg4';
const supabase=window.supabase.createClient(supabaseUrl,supabaseKey);

// å…¨å±€å˜é‡
let currentMode='total';
let totalRecords=[];
let users=[];
let lastClearTime=null;
let currentEditingRecordIndex=null;
let currentUser=null;
let usageTimer=null;
let sessionStartTime=null;

// å…³é”®å­—æ˜ å°„
const keywordMapping={
'é¼ ':'06 18 30 42','ç‰›':'05 17 29 41','è™':'04 16 28 40','å…”':'03 15 27 39','é¾™':'02 14 26 38',
'è›‡':'01 13 25 37 49','é©¬':'12 24 36 48','ç¾Š':'11 23 35 47','çŒ´':'10 22 34 46','é¸¡':'09 21 33 45',
'ç‹—':'08 20 32 44','çŒª':'07 19 31 43','é‡è‚–':'01 13 25 37 49 02 14 26 38 03 15 27 39 04 16 28 40 06 18 30 42 10 22 34 46',
'å®¶è‚–':'05 17 29 41 07 19 31 43 08 20 32 44 09 21 33 45 11 23 35 47 12 24 36 48',
'çº¢æ³¢':'01 02 07 08 12 13 18 19 23 24 29 30 34 35 40 45 46',
'è“æ³¢':'03 04 09 10 14 15 20 25 26 31 36 37 41 42 47 48',
'ç»¿æ³¢':'05 06 11 16 17 21 22 27 28 32 33 38 39 43 44 49',
'å°å•':'01 03 05 07 09 11 13 15 17 19 21 23',
'å¤§å•':'25 27 29 31 33 35 37 39 41 43 45 47 49',
'å°åŒ':'02 04 06 08 10 12 14 16 18 20 22 24',
'å¤§åŒ':'26 28 30 32 34 36 38 40 42 44 46 48',
'åˆåŒ':'02 04 06 08 11 13 15 17 19 20 22 24 26 28 31 33 35 37 39 40 42 44 46 48',
'åˆå•':'01 03 05 07 09 10 12 14 16 18 21 23 25 27 29 30 32 34 36 38 41 43 45 47 49',
'åˆå°':'01 02 03 04 05 06 10 11 12 13 14 15 20 21 22 23 24 30 31 32 33 40 41 42',
'åˆå¤§':'07 08 09 16 17 18 19 25 26 27 28 29 34 35 36 37 38 39 43 44 45 46 47 48 49',
'å•':'01 03 05 07 09 11 13 15 17 19 21 23 25 27 29 31 33 35 37 39 41 43 45 47 49',
'åŒ':'02 04 06 08 10 12 14 16 18 20 22 24 26 28 30 32 34 36 38 40 42 44 46 48',
'å¤§':'25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49',
'å°':'01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24',
'é‡‘':'03 04 11 12 25 26 33 34 41 42','æœ¨':'07 08 15 16 23 24 37 38 45 46','æ°´':'13 14 21 22 29 30 43 44',
'ç«':'01 02 09 10 17 18 31 32 39 40 47 48','åœŸ':'05 06 19 20 27 28 35 36 49',
'0å¤´':'01 02 03 04 05 06 07 08 09','1å¤´':'10 12 13 14 15 16 17 18 19','2å¤´':'20 21 22 23 24 25 26 27 28 29',
'3å¤´':'30 31 32 33 34 35 36 37 38 39','4å¤´':'40 41 42 43 44 45 46 47 48 49',
'0å°¾':'10 20 30 40','1å°¾':'01 11 21 31 41','2å°¾':'02 12 22 32 42','3å°¾':'03 13 23 33 43',
'4å°¾':'04 14 24 34 44','5å°¾':'05 15 25 35 45','6å°¾':'06 16 26 36 46','7å°¾':'07 17 27 37 47',
'8å°¾':'08 18 28 38 48','9å°¾':'09 19 29 39 49'
};

// åˆå§‹åŒ–åº”ç”¨
async function initializeApp(){
const isAuthenticated=await checkAuth();
if(!isAuthenticated){window.location.href='index.html';return;}
await loadCurrentUser();
await loadUsers();
await loadAllRecords();
loadLastClearTime();
refreshDisplay();
startUsageTimer();

// å›è½¦é”®ç™»å½•æ”¯æŒ
document.getElementById('inputText').addEventListener('keypress',function(e){
if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();submitData();}
});
}

// æ£€æŸ¥è®¤è¯çŠ¶æ€
async function checkAuth(){
const authToken=localStorage.getItem('auth_token');
const userPasswordHash=localStorage.getItem('user_password_hash');
if(!authToken||!userPasswordHash)return false;
try{const [storedHash]=atob(authToken).split(':');
if(storedHash!==userPasswordHash)return false;
const{data:user}=await supabase.from('users').select('*').eq('password_hash',userPasswordHash).single();
return user&&user.status==='active';
}catch(e){return false;}
}

// åŠ è½½å½“å‰ç”¨æˆ·ä¿¡æ¯
async function loadCurrentUser(){
const userPasswordHash=localStorage.getItem('user_password_hash');
if(!userPasswordHash){logoutUser();return;}
const{data:user}=await supabase.from('users').select('*').eq('password_hash',userPasswordHash).single();
if(user){
currentUser=user;
document.getElementById('userDisplayName').textContent=user.display_name||'ç”¨æˆ·';
let statusText='è´¦æˆ·çŠ¶æ€ï¼š';
if(user.status==='active'){
if(user.expire_date){
const expireDate=new Date(user.expire_date);
const now=new Date();
const daysLeft=Math.ceil((expireDate-now)/(1000*60*60*24));
statusText+=`æ­£å¸¸ï¼ˆå‰©ä½™${daysLeft}å¤©ï¼‰`;
}else{statusText+='æ­£å¸¸ï¼ˆæ°¸ä¹…ï¼‰';}
}else{statusText+=user.status==='inactive'?'å·²åœç”¨':'å·²è¿‡æœŸ';}
document.getElementById('userStatus').textContent=statusText;
}
}

// é€€å‡ºç™»å½•
function logoutUser(){
localStorage.removeItem('auth_token');
localStorage.removeItem('user_password_hash');
localStorage.removeItem('user_display_name');
localStorage.removeItem('login_time');
if(usageTimer)clearInterval(usageTimer);
window.location.href='index.html';
}

// ä½¿ç”¨æ—¶é—´ç»Ÿè®¡
function startUsageTimer(){
sessionStartTime=parseInt(localStorage.getItem('login_time')||Date.now());
function updateTimer(){
const now=Date.now();
const sessionSeconds=Math.floor((now-sessionStartTime)/1000);
const hours=Math.floor(sessionSeconds/3600);
const minutes=Math.floor((sessionSeconds%3600)/60);
const seconds=sessionSeconds%60;
document.getElementById('currentLoginTime').textContent=
`${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
}
updateTimer();
usageTimer=setInterval(updateTimer,1000);
}

// åŠ è½½ç”¨æˆ·åˆ—è¡¨
async function loadUsers(){
if(!currentUser)return;
const{data}=await supabase.from('user_settings').select('*').eq('password_hash',currentUser.password_hash);
if(data&&data.length>0){users=data[0].settings||[{name:'default',rate:45,rebate:3}];}
else{users=[{name:'default',rate:45,rebate:3}];}
updateNameSelect();
}

// æ›´æ–°åå­—é€‰æ‹©ä¸‹æ‹‰æ¡†
function updateNameSelect(){
const nameSelect=document.getElementById('nameList');
nameSelect.innerHTML='';
const defaultOption=document.createElement('option');
defaultOption.value='è¯·é€‰æ‹©';
defaultOption.textContent='è¯·é€‰æ‹©';
nameSelect.appendChild(defaultOption);
users.forEach(user=>{
const option=document.createElement('option');
option.value=user.name;
option.textContent=user.name;
nameSelect.appendChild(option);
});
}

// åŠ è½½æ‰€æœ‰è®°å½•
async function loadAllRecords(){
if(!currentUser)return;
const{data}=await supabase.from('user_records').select('*').eq('password_hash',currentUser.password_hash);
if(data&&data.length>0){totalRecords=data[0].records||[];}
else{totalRecords=[];}
}

// ä¿å­˜æ‰€æœ‰è®°å½•
async function saveAllRecords(){
if(!currentUser)return;
await supabase.from('user_records').upsert({
password_hash:currentUser.password_hash,
records:totalRecords,
updated_at:new Date().toISOString()
});
}

// åŠ è½½ä¸Šæ¬¡æ¸…é™¤æ—¶é—´
function loadLastClearTime(){
const savedTime=localStorage.getItem('numberStats_lastClearTime');
if(savedTime)lastClearTime=parseInt(savedTime);
}

// ä¿å­˜ä¸Šæ¬¡æ¸…é™¤æ—¶é—´
function saveLastClearTime(){
localStorage.setItem('numberStats_lastClearTime',lastClearTime.toString());
}

// è®¾ç½®æ˜¾ç¤ºæ¨¡å¼
function setMode(mode){
currentMode=mode;
document.getElementById('totalModeBtn').classList.toggle('active',mode==='total');
document.getElementById('personalModeBtn').classList.toggle('active',mode==='personal');
refreshDisplay();
}

// æäº¤æ•°æ®
function submitData(){
const inputText=document.getElementById('inputText').value.trim();
const selectedName=document.getElementById('nameList').value;
if(!inputText){alert('è¯·è¾“å…¥å†…å®¹ï¼ç¥ä½ å¤©å¤©å¼€å¿ƒï¼');return;}
const lines=inputText.split('\n');
let totalAdded=0;
let recordCount=0;
lines.forEach(line=>{
if(line.trim()){totalAdded+=processSingleLine(line.trim(),selectedName);recordCount++;}
});
saveAllRecords();
refreshDisplay();
let operationType=totalAdded>0?'å¢åŠ ':totalAdded<0?'å‡å°‘':'æ— å˜åŒ–';
let displayTotal=Math.abs(totalAdded);
let nameInfo=selectedName!=='è¯·é€‰æ‹©'?`ï¼ˆåå­—ï¼š${selectedName}ï¼‰`:'';
alert(`æˆåŠŸæ·»åŠ ${recordCount}æ¡è®°å½•${nameInfo}ï¼Œæ€»é‡${operationType}: ${displayTotal}`);
document.getElementById('inputText').value='';
}

// å¤„ç†å•è¡Œæ•°æ® 
function processSingleLine(inputStr, name) {
    const originalInput = inputStr;
    
    if (!validateInputFormat(inputStr)) {
        return 0;
    }
    
    inputStr = standardizeInputFormat(inputStr);
    
    const { numbersPart, quantity } = parseInputParts(inputStr);
    
    if (isNaN(quantity) || quantity <= 0) {
        alert('è¯·è¾“å…¥å¤§äº0çš„æ•°å­—');
        return 0;
    }
    return processNormalNumbers(numbersPart, quantity, name, originalInput);
}
function validateInputFormat(inputStr) {
    // æ£€æŸ¥æ˜¯å¦åŒ…å«"å„"æˆ–"+"
    if (!inputStr.includes('å„') && !inputStr.includes('+')) {
        alert('æ ¼å¼é”™è¯¯ï¼è¯·ä½¿ç”¨"+"æˆ–"å„"ï¼');
        return false;
    }
    return true;
}
function standardizeInputFormat(inputStr) {
    return inputStr.replace(/å„/g, '+');
}
function parseInputParts(inputStr) {
    const plusIndex = inputStr.lastIndexOf('+');
    
    if (plusIndex === -1) {
        alert('æ ¼å¼é”™è¯¯ï¼è¯·ä½¿ç”¨"+"æˆ–"å„"ï¼');
        return { numbersPart: '', quantity: 0 };
    }
    
    const numbersPart = inputStr.substring(0, plusIndex).trim();
    const quantity = parseInt(inputStr.substring(plusIndex + 1).trim());
    
    return { numbersPart, quantity };
}
function processNormalNumbers(numbersPart, quantity, name, originalInput) {
    const convertedNumbers = convertKeywords(numbersPart);
    const numberArray = parseNumberString(convertedNumbers);
    
    if (numberArray.length === 0) {
        alert('è¾“å…¥æ ¼å¼æœ‰è¯¯ï¼');
        return 0;
    }
    saveRecord(name, originalInput, numberArray.join(' '), quantity, 'normal');
    
    return numberArray.length * quantity;
}
function parseNumberString(numberStr) {
    const numbers = [];
    const matches = numberStr.match(/\d+/g);
    
    if (matches) {
        matches.forEach(numStr => {
            if (numStr.length === 1) {
                // å•ä¸ªæ•°å­—
                const twoDigits = numStr.padStart(2, '0');
                if (isValidNumber(twoDigits)) {
                    numbers.push(twoDigits);
                }
            } else if (numStr.length === 2) {
                // ä¸¤ä½æ•°
                if (isValidNumber(numStr)) {
                    numbers.push(numStr);
                }
            } else {
                for (let i = 0; i < numStr.length; i += 2) {
                    if (i + 2 <= numStr.length) {
                        let twoDigits = numStr.substring(i, i + 2);
                        if (twoDigits.length === 1) {
                            twoDigits = twoDigits.padStart(2, '0');
                        }
                        if (isValidNumber(twoDigits)) {
                            numbers.push(twoDigits);
                        }
                    }
                }
            }
        });
    }
    
    return numbers;
}
    function convertKeywords(inputStr) {
        const sortedKeys = Object.keys(keywordMapping).sort((a, b) => b.length - a.length);
        
        let result = inputStr;
        sortedKeys.forEach(keyword => {
            const regex = new RegExp(keyword, 'g');
            if (regex.test(result)) {
                result = result.replace(regex, keywordMapping[keyword]);
            }
        });
        
        return result;
    }
// éªŒè¯å·ç æœ‰æ•ˆæ€§
function isValidNumber(numStr){
if(numStr.length!==2||!/^\d+$/.test(numStr))return false;
const num=parseInt(numStr);
return num>=1&&num<=49;
}

// è·å–å·ç å¯¹åº”çš„ç”Ÿè‚–
function getAnimalName(number){
const num=parseInt(number);
switch(num){
case 1:case 13:case 25:case 37:case 49:return"è›‡";
case 2:case 14:case 26:case 38:return"é¾™";
case 3:case 15:case 27:case 39:return"å…”";
case 4:case 16:case 28:case 40:return"è™";
case 5:case 17:case 29:case 41:return"ç‰›";
case 6:case 18:case 30:case 42:return"é¼ ";
case 7:case 19:case 31:case 43:return"çŒª";
case 8:case 20:case 32:case 44:return"ç‹—";
case 9:case 21:case 33:case 45:return"é¸¡";
case 10:case 22:case 34:case 46:return"çŒ´";
case 11:case 23:case 35:case 47:return"ç¾Š";
case 12:case 24:case 36:case 48:return"é©¬";
default:return"æœªçŸ¥";
}
}

// ä¿å­˜è®°å½•
function saveRecord(name,inputText,numbers,quantity){
totalRecords.push({
name:name,
inputText:inputText,
numbers:numbers,
quantity:quantity,
timestamp:new Date().getTime()
});
}

// åˆ·æ–°æ˜¾ç¤º
function refreshDisplay(){
if(currentMode==='total')displayTotalNumbers();
else{
const selectedName=document.getElementById('nameList').value;
displayPersonalNumbers(selectedName);
}
}

// æ˜¾ç¤ºæ€»é‡
function displayTotalNumbers(){
const totalDict=calculateTotal();
displayNumbers(totalDict,'æ€»é‡æ˜¾ç¤º - æ‰€æœ‰ç”¨æˆ·åˆè®¡');
displayTotalStats();
}

// æ˜¾ç¤ºä¸ªäººæ•°é‡
function displayPersonalNumbers(name){
const personalDict=calculatePersonalTotal(name);
displayNumbers(personalDict,`ä¸ªäººæ˜¾ç¤º - ${name}`);
displayPersonalStats(name);
}

// è®¡ç®—æ€»é‡
function calculateTotal(){
let totalDict={};
for(let i=1;i<=49;i++)totalDict[String(i).padStart(2,'0')]=0;
totalRecords.forEach(record=>{
const numbers=record.numbers.split(' ');
numbers.forEach(num=>{
if(num in totalDict)totalDict[num]+=record.quantity;
});
});
return totalDict;
}

// è®¡ç®—ä¸ªäººæ€»é‡
function calculatePersonalTotal(name){
let personalDict={};
for(let i=1;i<=49;i++)personalDict[String(i).padStart(2,'0')]=0;
totalRecords.forEach(record=>{
if(record.name===name){
const numbers=record.numbers.split(' ');
numbers.forEach(num=>{
if(num in personalDict)personalDict[num]+=record.quantity;
});
}
});
return personalDict;
}

// è®¡ç®—ä¸ªäººç»Ÿè®¡
function calculatePersonalStats(){
let stats={};
totalRecords.forEach(record=>{
if(!stats[record.name])stats[record.name]={recordCount:0,totalQuantity:0};
stats[record.name].recordCount++;
const numbersCount=record.numbers.split(' ').length;
stats[record.name].totalQuantity+=numbersCount*record.quantity;
});
return stats;
}

// æ˜¾ç¤ºå·ç 
function displayNumbers(numberDict,title){
let numbersArray=[];
for(let i=1;i<=49;i++){
const num=String(i).padStart(2,'0');
numbersArray.push({number:num,count:numberDict[num]||0});
}
numbersArray.sort((a,b)=>b.count-a.count);
document.getElementById('numberColumn1').innerHTML='';
document.getElementById('numberColumn2').innerHTML='';
const column1=document.getElementById('numberColumn1');
const column2=document.getElementById('numberColumn2');
for(let i=0;i<numbersArray.length;i++){
const item=numbersArray[i];
const animalName=getAnimalName(item.number);
const numberItem=document.createElement('div');
numberItem.className='number-item';
numberItem.innerHTML=`<span class=number-code>${animalName}${item.number}</span><span class=number-count>${item.count}</span>`;
i<25?column1.appendChild(numberItem):column2.appendChild(numberItem);
}
document.getElementById('displayTitle').textContent=title;
}

// æ˜¾ç¤ºæ€»é‡ç»Ÿè®¡
function displayTotalStats(){
const totalDict=calculateTotal();
let totalQuantity=0;
Object.values(totalDict).forEach(count=>{totalQuantity+=count;});
let statsHTML=`æ€»è®°å½•æ•°: ${totalRecords.length} æ¡ | æ€»æ•°é‡: ${totalQuantity}`;
const statsDict=calculatePersonalStats();
Object.keys(statsDict).forEach(name=>{
statsHTML+=`<br>${name}: ${statsDict[name].recordCount}å• æ€»è®¡${statsDict[name].totalQuantity}`;
});
document.getElementById('statsText').innerHTML=statsHTML;
}

// æ˜¾ç¤ºä¸ªäººç»Ÿè®¡
function displayPersonalStats(name){
const personalDict=calculatePersonalTotal(name);
let personalQuantity=0;
Object.values(personalDict).forEach(count=>{personalQuantity+=count;});
let personalRecordsCount=0;
totalRecords.forEach(record=>{if(record.name===name)personalRecordsCount++;});
const statsHTML=`è®°å½•æ•°: ${personalRecordsCount} æ¡ | æ€»æ•°é‡: ${personalQuantity}`;
document.getElementById('statsText').textContent=statsHTML;
}

// é¡µé¢åˆ‡æ¢å‡½æ•°
function toggleDisplay(){
const numbersArea=document.getElementById('numbersDisplayArea');
const settlementArea=document.getElementById('settlementEvaluationArea');
const switchBtn=document.getElementById('switchToSettlementBtn');
if(numbersArea.style.display!=='none'){
numbersArea.style.display='none';
settlementArea.style.display='block';
switchBtn.textContent='å·ç æ˜¾ç¤º';
}else{
numbersArea.style.display='block';
settlementArea.style.display='none';
switchBtn.textContent='ç»“ç®—é¡µé¢';
}
}

// æ˜¾ç¤ºç”¨æˆ·ç®¡ç†æ¨¡æ€æ¡†
function showUserManagement(){
document.getElementById('userManagementModal').style.display='flex';
renderUserTable();
}

// éšè—ç”¨æˆ·ç®¡ç†æ¨¡æ€æ¡†
function hideUserManagement(){
document.getElementById('userManagementModal').style.display='none';
}

// æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼
function renderUserTable(){
const tbody=document.getElementById('userTableBody');
tbody.innerHTML='';
users.forEach((user,index)=>{
const row=document.createElement('tr');
row.innerHTML=`<td><button class=danger onclick="deleteUser(${index})">åˆ é™¤</button></td>
<td><input type=text class=user-name value="${user.name}" onchange="updateUserField(${index},'name',this.value)"></td>
<td><input type=number class=user-rate value="${user.rate}" onchange="updateUserField(${index},'rate',this.value)"></td>
<td><input type=number class=user-rebate value="${user.rebate}" onchange="updateUserField(${index},'rebate',this.value)"></td>`;
tbody.appendChild(row);
});
}

// åˆ é™¤ç”¨æˆ·
function deleteUser(index){
if(confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${users[index].name} å—ï¼Ÿ`)){
users.splice(index,1);
renderUserTable();
}
}

// æ›´æ–°ç”¨æˆ·å­—æ®µ
function updateUserField(index,field,value){
users[index][field]=value;
}

// æ·»åŠ æ–°ç”¨æˆ·
function addNewUser(){
const name=document.getElementById('newUserName').value.trim();
const rate=parseInt(document.getElementById('newUserRate').value);
const rebate=parseInt(document.getElementById('newUserRebate').value);
if(!name){alert('è¯·è¾“å…¥ç”¨æˆ·åå­—ï¼');return;}
if(users.some(user=>user.name===name)){alert('ç”¨æˆ·åå­—å·²å­˜åœ¨ï¼');return;}
users.push({
name:name,
rate:isNaN(rate)?45:rate,
rebate:isNaN(rebate)?3:rebate
});
document.getElementById('newUserName').value='';
document.getElementById('newUserRate').value=45;
document.getElementById('newUserRebate').value=3;
renderUserTable();
updateNameSelect();
alert(`ç”¨æˆ· ${name} æ·»åŠ æˆåŠŸï¼`);
}

// ä¿å­˜ç”¨æˆ·è®¾ç½®
async function saveUsers(){
if(!currentUser)return;
await supabase.from('user_settings').upsert({
password_hash:currentUser.password_hash,
settings:users,
updated_at:new Date().toISOString()
});
updateNameSelect();
hideUserManagement();
alert('ç”¨æˆ·è®¾ç½®å·²ä¿å­˜ï¼');
}

// è®¡ç®—ç»“ç®—
function calculateSettlement(){
const winningNumber=document.getElementById('winningNumber').value.trim();
if(!winningNumber){alert('è¯·è¾“å…¥ç‰¹ç ï¼');return;}
const winningNumbers=winningNumber.split(' ').filter(num=>num.trim()!=='');
const settlementData=[];
let totals={totalBet:0,totalRebateAmount:0,totalAfterRebate:0,totalWinningAmount:0,totalProfitLoss:0};
users.forEach(user=>{
const userDict=calculatePersonalTotal(user.name);
let userTotalQuantity=0;
Object.values(userDict).forEach(count=>{userTotalQuantity+=count;});
if(userTotalQuantity===0)return;
const rebateAmount=Math.round(userTotalQuantity*user.rebate/100);
const afterRebate=userTotalQuantity-rebateAmount;
let winningQuantity=0;
winningNumbers.forEach(num=>{if(userDict[num])winningQuantity+=userDict[num];});
const winningAmount=winningQuantity;
const profitLoss=winningQuantity*user.rate-afterRebate;
settlementData.push({
name:user.name,rate:user.rate,rebate:user.rebate,totalBet:userTotalQuantity,
rebateAmount:rebateAmount,afterRebate:afterRebate,winningAmount:winningAmount,profitLoss:profitLoss
});
totals.totalBet+=userTotalQuantity;
totals.totalRebateAmount+=rebateAmount;
totals.totalAfterRebate+=afterRebate;
totals.totalWinningAmount+=winningAmount;
totals.totalProfitLoss+=profitLoss;
});
showSettlementResult(winningNumber,settlementData,totals);
}

// æ˜¾ç¤ºç»“ç®—ç»“æœ
function showSettlementResult(winningNumber,settlementData,totals){
document.getElementById('settlementWinningNumbers').textContent=winningNumber;
const tbody=document.getElementById('settlementTableBody');
tbody.innerHTML='';
settlementData.forEach(item=>{
const row=document.createElement('tr');
row.innerHTML=`<td>${item.name}</td><td>${item.totalBet}</td><td>${item.rebateAmount}</td>
<td>${item.afterRebate}</td><td>${item.winningAmount}</td>
<td class=${item.profitLoss>=0?'profit':'loss'}>${item.profitLoss>=0?'+':''}${item.profitLoss}</td>
<td><button onclick="copySettlementRow('${item.name}',${item.totalBet},${item.rebateAmount},${item.afterRebate},${item.winningAmount},${item.profitLoss})">å¤åˆ¶</button></td>`;
tbody.appendChild(row);
});
const tfoot=document.getElementById('settlementTableFooter');
tfoot.innerHTML=`<tr><td><strong>æ€»è®¡</strong></td><td><strong>${totals.totalBet}</strong></td>
<td><strong>${totals.totalRebateAmount}</strong></td><td><strong>${totals.totalAfterRebate}</strong></td>
<td><strong>${totals.totalWinningAmount}</strong></td>
<td class=${totals.totalProfitLoss>=0?'profit':'loss'}><strong>${totals.totalProfitLoss>=0?'+':''}${totals.totalProfitLoss}</strong></td><td></td></tr>`;
document.getElementById('settlementResultModal').style.display='flex';
}

// å¤åˆ¶ç»“ç®—è¡Œ
function copySettlementRow(name,total,rebate,after,winning,profit){
const copyText=`${name}: ä¸­${winning}-ï¼ˆæ€»é¢${total}-${rebate}=${after}ï¼‰=${profit}`;
navigator.clipboard.writeText(copyText).then(()=>{
alert(`å·²å¤åˆ¶: ${copyText}`);
}).catch(()=>{
const textArea=document.createElement('textarea');
textArea.value=copyText;
document.body.appendChild(textArea);
textArea.select();
document.execCommand('copy');
document.body.removeChild(textArea);
alert(`å·²å¤åˆ¶: ${copyText}`);
});
}

// éšè—ç»“ç®—ç»“æœ
function hideSettlementResult(){
document.getElementById('settlementResultModal').style.display='none';
}

// è¯„ä¼°ç³»ç»Ÿ
function evaluateSystem(){
const totalDict=calculateTotal();
let totalQuantity=0;
Object.values(totalDict).forEach(count=>{totalQuantity+=count;});
let maxCount=0;
Object.values(totalDict).forEach(count=>{if(count>maxCount)maxCount=count;});
const minProfitOrMaxLoss=totalQuantity-maxCount*47;
const evaluationResult=document.getElementById('evaluationResult');
evaluationResult.innerHTML=`<div class=evaluation-result><h3>ç³»ç»Ÿè¯„ä¼°</h3>
<p>åŸºæœ¬å€¼: ${(totalQuantity/45).toFixed(2)}</p>
<p>é¢„è®¡${minProfitOrMaxLoss>=0?'æœ€å°ç›ˆåˆ©':'æœ€å¤§äºæŸ'}: ${Math.abs(minProfitOrMaxLoss)}</p>
<p>è®¡ç®—æ–¹å¼: æœ€å¤§æ•°é‡(${maxCount}) Ã— 47 - æ€»æ•°é‡(${totalQuantity})</p></div>`;
}

// åƒç è®¡ç®—
function calculateExcess(){
const threshold=parseInt(document.getElementById('thresholdInput').value);
if(isNaN(threshold)){alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢ï¼');return;}
const totalDict=calculateTotal();
const excessNumbers=[];
for(let i=1;i<=49;i++){
const num=String(i).padStart(2,'0');
if(totalDict[num]>threshold){
excessNumbers.push({number:num,count:totalDict[num],excess:totalDict[num]-threshold});
}
}
excessNumbers.sort((a,b)=>b.excess-a.excess);
const excessResult=document.getElementById('excessResult');
excessResult.innerHTML='';
if(excessNumbers.length===0){excessResult.innerHTML='<p>æ²¡æœ‰è¶…è¿‡çš„å·ç </p>';return;}
const groupedByExcess={};
excessNumbers.forEach(item=>{
if(!groupedByExcess[item.excess])groupedByExcess[item.excess]=[];
groupedByExcess[item.excess].push(item.number);
});
let copyText='';
Object.keys(groupedByExcess).sort((a,b)=>b-a).forEach(excessAmount=>{
copyText+=`${groupedByExcess[excessAmount].join(' ')}å„${excessAmount}\n`;
});
copyText=copyText.trim();
const resultDiv=document.createElement('div');
resultDiv.className='evaluation-result';
resultDiv.innerHTML='<h3>åƒç ç»“æœ</h3>';
Object.keys(groupedByExcess).sort((a,b)=>b-a).forEach(excessAmount=>{
const itemDiv=document.createElement('div');
itemDiv.className='excess-group';
itemDiv.innerHTML=`<div><div class=excess-numbers>${groupedByExcess[excessAmount].join(' ')}</div></div>
<div class=excess-amount>å„${excessAmount}</div>`;
resultDiv.appendChild(itemDiv);
});
const copyButton=document.createElement('button');
copyButton.className='success';
copyButton.style.marginTop='10px';
copyButton.style.width='100%';
copyButton.innerHTML='å¤åˆ¶åƒç ç»“æœ';
copyButton.addEventListener('click',function(){
navigator.clipboard.writeText(copyText).then(()=>{
const originalText=copyButton.innerHTML;
copyButton.innerHTML='âœ“ å·²å¤åˆ¶';
copyButton.classList.add('copy-success','copy-btn-pulse');
setTimeout(()=>{
copyButton.innerHTML=originalText;
copyButton.classList.remove('copy-success','copy-btn-pulse');
},2000);
}).catch(()=>{
const textArea=document.createElement('textarea');
textArea.value=copyText;
document.body.appendChild(textArea);
textArea.select();
try{
document.execCommand('copy');
const originalText=copyButton.innerHTML;
copyButton.innerHTML='âœ“ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
copyButton.classList.add('copy-success','copy-btn-pulse');
setTimeout(()=>{
copyButton.innerHTML=originalText;
copyButton.classList.remove('copy-success','copy-btn-pulse');
},2000);
}catch(err){alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');}
document.body.removeChild(textArea);
});
});
resultDiv.appendChild(copyButton);
excessResult.appendChild(resultDiv);
}

// æ˜¾ç¤ºæ¸…é™¤ç¡®è®¤æ¨¡æ€æ¡†
function showClearConfirm(){
document.getElementById('confirmClearModal').style.display='flex';
}

// éšè—æ¸…é™¤ç¡®è®¤æ¨¡æ€æ¡†
function hideClearConfirm(){
document.getElementById('confirmClearModal').style.display='none';
}

// ç¡®è®¤æ¸…é™¤æ•°æ®
function confirmClearData(){
lastClearTime=new Date().getTime();
saveLastClearTime();
totalRecords=[];
saveAllRecords();
hideClearConfirm();
refreshDisplay();
alert('å·²æ¸…é™¤æ‰€æœ‰æ•°æ®è®°å½•');
}

// æ˜¾ç¤ºè®°å½•
function showRecords(){
const recordsList=document.getElementById('recordsList');
const editForm=document.getElementById('editRecordForm');
recordsList.innerHTML='';
editForm.style.display='none';
const recentRecords=lastClearTime?totalRecords.filter(record=>record.timestamp>lastClearTime):[...totalRecords];
if(recentRecords.length===0){recordsList.innerHTML='<p>æš‚æ— è®°å½•</p>';}
else{
recentRecords.forEach((record,index)=>{
const recordElement=document.createElement('div');
recordElement.className='record-item';
recordElement.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
<div><strong>${record.name}</strong>ï¼š${record.inputText}
<div style="font-size:12px;color:#666">å·ç : ${record.numbers} | æ•°é‡: ${record.quantity>0?'+':''}${record.quantity}</div>
</div><button onclick="showEditForm(${index})">ä¿®æ”¹</button></div>`;
recordsList.appendChild(recordElement);
});
}
document.getElementById('recordsModal').style.display='flex';
}

// æ˜¾ç¤ºç¼–è¾‘è¡¨å•
function showEditForm(index){
currentEditingRecordIndex=index;
const record=totalRecords[index];
document.getElementById('editRecordContent').value=record.inputText;
document.getElementById('editRecordForm').style.display='block';
document.getElementById('editRecordForm').scrollIntoView({behavior:'smooth'});
}

// å–æ¶ˆç¼–è¾‘
function cancelEdit(){
document.getElementById('editRecordForm').style.display='none';
currentEditingRecordIndex=null;
}

// ä¿å­˜ç¼–è¾‘
function saveEdit(){
if(currentEditingRecordIndex===null)return;
const newInputText=document.getElementById('editRecordContent').value.trim();
if(!newInputText){alert('è¯·ä¿®æ”¹ï¼');return;}
const record=totalRecords[currentEditingRecordIndex];
const name=record.name;
totalRecords.splice(currentEditingRecordIndex,1);
processSingleLine(newInputText,name);
saveAllRecords();
refreshDisplay();
cancelEdit();
showRecords();
alert(`è®°å½•ä¿®æ”¹æˆåŠŸï¼`);
}

// éšè—è®°å½•æ¨¡æ€æ¡†
function hideRecords(){
document.getElementById('recordsModal').style.display='none';
currentEditingRecordIndex=null;
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded',initializeApp);
</script></body></html>